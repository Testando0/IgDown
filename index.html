<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kuromi Downloader | Button Download Fix</title>

  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root { --neon-purple:#a855f7; --neon-pink:#ff00aa; --dark-bg:#050505; }
    
    body { 
        font-family:'Outfit',sans-serif; background:var(--dark-bg); min-height:100vh; color:#e4e4e7;
        background-image: radial-gradient(circle at 50% 0%, rgba(168, 85, 247, 0.15) 0%, transparent 50%),
                          radial-gradient(circle at 0% 100%, rgba(255, 0, 170, 0.1) 0%, transparent 50%); 
        overflow-x: hidden;
    }

    .dark-glass { 
        background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(168, 85, 247, 0.2); box-shadow: 0 0 30px rgba(0,0,0,0.5); 
    }

    .glow-focus:focus-within { box-shadow: 0 0 25px rgba(168,85,247,0.25); border-color: rgba(168,85,247,0.5); }

    .loader { 
        border: 3px solid rgba(255,255,255,0.1); border-left-color: var(--neon-pink); border-radius: 50%; 
        width: 24px; height: 24px; animation: spin 1s linear infinite; 
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    @keyframes fadeUp { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
    .animate-fade-up { animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .orbitron { font-family: 'Orbitron', sans-serif; }

    .platform-btn { transition: all 0.3s ease; opacity: 0.5; filter: grayscale(100%); }
    .platform-btn.active { opacity: 1; filter: grayscale(0%); background: rgba(168, 85, 247, 0.15); border: 1px solid var(--neon-purple); box-shadow: 0 0 15px rgba(168, 85, 247, 0.2); }
  </style>
</head>

<body class="flex flex-col items-center justify-center p-4 md:p-8">

  <nav class="absolute top-0 left-0 w-full p-6 flex justify-between items-center max-w-7xl mx-auto z-10">
    <div class="flex items-center gap-3 text-xl font-bold tracking-wider">
      <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-pink-600 rounded-lg flex items-center justify-center shadow-[0_0_15px_rgba(168,85,247,0.5)]">
        <i class="fa-solid fa-bolt text-white text-lg"></i>
      </div>
      <span class="text-white orbitron">Kuromi<span class="text-purple-400">DL</span></span>
    </div>
    <div class="text-[10px] font-medium text-zinc-500 border border-zinc-800 px-3 py-1 rounded-full bg-zinc-900/50 tracking-widest">BUTTON FIX</div>
  </nav>

  <main class="w-full max-w-2xl mt-20 relative z-0">
    
    <div class="text-center mb-8 animate-fade-up">
      <h1 class="text-4xl md:text-6xl font-bold mb-4 text-white orbitron drop-shadow-[0_0_10px_rgba(168,85,247,0.5)]">
        Baixe <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">Agora</span>
      </h1>
      <p class="text-zinc-400 text-lg font-light">Cole o link. Baixe o v√≠deo.</p>
    </div>

    <div class="flex justify-center gap-3 mb-6 animate-fade-up" style="animation-delay: 0.05s;">
        <button onclick="switchPlatform('insta')" id="btn-insta" class="platform-btn active px-6 py-2 rounded-full text-white font-bold orbitron bg-zinc-900 flex items-center gap-2">
            <i class="fa-brands fa-instagram"></i> Insta
        </button>
        <button onclick="switchPlatform('threads')" id="btn-threads" class="platform-btn px-6 py-2 rounded-full text-white font-bold orbitron bg-zinc-900 flex items-center gap-2">
            <i class="fa-brands fa-threads"></i> Threads
        </button>
    </div>

    <div class="dark-glass rounded-2xl p-2 mb-8 animate-fade-up glow-focus transition-all duration-300" style="animation-delay: 0.1s;">
      <div class="relative flex items-center">
        <div class="absolute left-4 text-purple-500 text-xl" id="inputIcon"><i class="fa-brands fa-instagram"></i></div>
        
        <input type="text" id="urlInput" placeholder="Link do Instagram..." class="w-full bg-transparent border-none text-zinc-100 placeholder-zinc-600 px-12 py-4 focus:ring-0 focus:outline-none text-lg font-light orbitron">
        
        <div class="absolute right-2">
          <button onclick="processDownload()" id="mainBtn" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white px-8 py-3 rounded-xl font-bold transition-all shadow-lg shadow-purple-900/40 flex items-center gap-2 hover:scale-105 active:scale-95">
            <span id="btnText">BAIXAR</span>
            <div id="btnLoader" class="loader hidden"></div>
          </button>
        </div>
      </div>
    </div>

    <div id="resultArea" class="hidden animate-fade-up" style="animation-delay:0.2s;">
      <div class="dark-glass rounded-2xl p-6 border border-zinc-800 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-purple-600/10 rounded-full blur-3xl -z-10 pointer-events-none"></div>
        
        <div class="flex flex-col gap-6">
            <div class="relative w-full rounded-xl overflow-hidden border border-zinc-700 bg-black shadow-2xl">
                <video id="previewPlayer" class="w-full max-h-[450px]" controls playsinline></video>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-left w-full">
                    <h3 class="text-xl font-bold text-white orbitron mb-1">V√≠deo Pronto</h3>
                    <span id="platformTag" class="inline-block text-[10px] bg-zinc-800 px-2 py-1 rounded border border-zinc-700 text-zinc-400 uppercase">INSTAGRAM</span>
                    <p id="fallbackMsg" class="text-red-400 text-xs mt-2 hidden"><i class="fa-solid fa-ban"></i> A√ß√£o bloqueada pelo Threads. Use o menu "Tocar e Segurar" (Mobile) ou "Bot√£o Direito" (PC) no player acima.</p>
                </div>

                <div class="w-full md:w-auto flex flex-col gap-2">
                    <button id="btnDownloadFile" onclick="smartDownload()" class="w-full md:w-auto bg-white text-black hover:bg-gray-200 px-6 py-3 rounded-lg font-bold text-center transition flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(255,255,255,0.2)]">
                        <i class="fa-solid fa-download"></i> <span id="dlBtnText">SALVAR V√çDEO</span>
                        <div id="dlLoader" class="loader hidden border-zinc-400 border-l-black w-4 h-4"></div>
                    </button>
                </div>
            </div>
        </div>
      </div>
    </div>

    <div id="errorMsg" class="hidden mt-4 p-4 bg-red-500/10 border border-red-500/30 rounded-xl flex items-center gap-3 animate-fade-up backdrop-blur-md">
      <i class="fa-solid fa-circle-exclamation text-red-500"></i>
      <span id="errorText" class="text-red-200 text-sm font-medium">Erro ao processar.</span>
    </div>

  </main>

  <footer class="fixed bottom-6 text-center w-full text-zinc-700 text-[10px] tracking-[0.3em] pointer-events-none orbitron">SYSTEM: KUROMI TECH</footer>

<script>
/* ================= CONFIGURA√á√ÉO ================= */
const PROXY_URL = 'https://corsproxy.io/?';

const APIS = {
    insta: 'https://kuromi-system-tech.onrender.com/api/insta?url=',
    threads: 'https://kuromi-system-tech.onrender.com/api/threads?url='
};

/* =============== ESTADO ================= */
let currentPlatform = 'insta'; 
let foundVideoUrl = ''; 
let foundFilename = '';

/* =============== UI CONTROL =============== */
function switchPlatform(platform) {
    currentPlatform = platform;
    document.querySelectorAll('.platform-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`btn-${platform}`).classList.add('active');
    const input = document.getElementById('urlInput');
    const icon = document.getElementById('inputIcon');
    
    if(platform === 'insta') {
        input.placeholder = "Link do Instagram...";
        icon.innerHTML = '<i class="fa-brands fa-instagram"></i>';
    } else {
        input.placeholder = "Link do Threads...";
        icon.innerHTML = '<i class="fa-brands fa-threads"></i>';
    }
    resetUI(true);
}

function detectPlatform(rawUrl) {
    // FUN√á√ÉO agora √© chamada APENAS em processDownload
    if(rawUrl.includes('threads.net')) return 'threads';
    if(rawUrl.includes('instagram.com')) return 'insta';
    return currentPlatform; // Mant√©m a plataforma selecionada se n√£o for detectado
}

/* =============== L√ìGICA PRINCIPAL =============== */
async function processDownload(){
    const input = document.getElementById('urlInput');
    const rawUrl = input.value.trim();

    resetUI(false); 

    if(!rawUrl) { showError('Insira um link v√°lido! üíú'); return; }

    setSearchLoading(true);

    try {
        // Auto-detec√ß√£o no momento de processar (melhor para a colagem)
        const detectedPlatform = detectPlatform(rawUrl);
        switchPlatform(detectedPlatform); // Atualiza o UI para a plataforma detectada
        
        const apiUrlBase = APIS[currentPlatform];
        const targetApiUrl = apiUrlBase + encodeURIComponent(rawUrl);
        
        const res = await fetch(targetApiUrl); 
        if(!res.ok) throw new Error(`API Error: ${res.status}`);

        const json = await res.json();
        
        let videoData = null;

        if (currentPlatform === 'insta') {
            if (!json.data || !json.data.data || json.data.data.length < 1) throw new Error("V√≠deo Insta n√£o encontrado.");
            videoData = json.data.data[0];
        } 
        else if (currentPlatform === 'threads') {
            if (json.result && json.result.media && json.result.media.length > 0) {
                videoData = json.result.media[0];
            } else {
                throw new Error("V√≠deo Threads n√£o encontrado.");
            }
        }

        if (!videoData || !videoData.url) throw new Error("Link de v√≠deo inv√°lido.");

        foundVideoUrl = videoData.url;
        foundFilename = `kuromi_${currentPlatform}_${Date.now()}.mp4`;

        showResult(foundVideoUrl);

    } catch (error) {
        console.error(error);
        let msg = "Erro ao buscar v√≠deo. Tente novamente.";
        if(error.message.includes("Failed to fetch")) msg = "API Offline no momento. Aguarde 1min.";
        showError(msg);
    } finally {
        setSearchLoading(false);
    }
}

/* =============== DOWNLOAD (√öLTIMO RECURSO SEM REDIRECIONAMENTO) =============== */
function smartDownload() {
    if(!foundVideoUrl) return;

    setDownloadLoading(true);
    document.getElementById('fallbackMsg').classList.add('hidden');

    // Tenta usar a t√©cnica do link de download simples.
    try {
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = foundVideoUrl;
        a.download = foundFilename; 
        
        document.body.appendChild(a);
        a.click();
        a.remove();
        
        // Simula um tempo de espera para ver se o navegador inicia o download
        setTimeout(() => {
            // Se o download n√£o for detectado e o URL for Threads, a probabilidade √© de falha.
            if (currentPlatform === 'threads') {
                 document.getElementById('fallbackMsg').classList.remove('hidden');
            }
            setDownloadLoading(false);
        }, 1500);


    } catch (error) {
        console.error("Tentativa de download pelo bot√£o falhou:", error);
        
        document.getElementById('fallbackMsg').classList.remove('hidden');
        document.getElementById('fallbackMsg').innerText = "‚ùå Download Bloqueado: N√£o √© poss√≠vel salvar sem redirecionar. Use o menu do player.";
        
        setDownloadLoading(false);
    }
}

/* =============== HELPERS DE UI =============== */
function showResult(url) {
    const player = document.getElementById('previewPlayer');
    player.src = url;
    document.getElementById('platformTag').innerText = currentPlatform.toUpperCase();
    document.getElementById('resultArea').classList.remove('hidden');
    document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function showError(msg) {
    const el = document.getElementById('errorText');
    const box = document.getElementById('errorMsg');
    el.innerText = msg;
    box.classList.remove('hidden');
}

function resetUI(clearInput = true) {
    document.getElementById('errorMsg').classList.add('hidden');
    document.getElementById('resultArea').classList.add('hidden');
    document.getElementById('previewPlayer').pause();
    document.getElementById('previewPlayer').src = "";
    document.getElementById('fallbackMsg').classList.add('hidden');
    if (clearInput) document.getElementById('urlInput').value = "";
}

function setSearchLoading(isLoading) {
    const btn = document.getElementById('mainBtn');
    const txt = document.getElementById('btnText');
    const load = document.getElementById('btnLoader');
    if(isLoading) { txt.classList.add('hidden'); load.classList.remove('hidden'); btn.disabled = true; btn.classList.add('opacity-70'); }
    else { txt.classList.remove('hidden'); load.classList.add('hidden'); btn.disabled = false; btn.classList.remove('opacity-70'); }
}

function setDownloadLoading(isLoading) {
    const btn = document.getElementById('btnDownloadFile');
    const txt = document.getElementById('dlBtnText');
    const load = document.getElementById('dlLoader');
    if(isLoading) { txt.innerText = "TENTANDO SALVAR..."; load.classList.remove('hidden'); btn.disabled = true; }
    else { txt.innerText = "SALVAR V√çDEO"; load.classList.add('hidden'); btn.disabled = false; }
}

document.getElementById('urlInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') processDownload(); });
</script>
</body>
</html>
