Document.addEventListener("DOMContentLoaded", () => {
    
    // Seleciona os elementos do HTML
    const form = document.getElementById("download-form");
    const urlInput = document.getElementById("url-input");
    const downloadButton = document.getElementById("download-button");
    const buttonText = downloadButton.querySelector(".button-text");
    const buttonLoader = downloadButton.querySelector(".button-loader");
    const messageArea = document.getElementById("message-area");
    const resultArea = document.getElementById("result-area");
    
    const platformSelect = document.getElementById("platform-select");

    // Adiciona um "ouvinte" para o evento de submit do formul√°rio
    // (N√£o precisamos mais de 'async' aqui)
    form.addEventListener("submit", (event) => {
        event.preventDefault(); 
        
        const userUrl = urlInput.value.trim();
        const platform = platformSelect.value; 

        // 1. Valida√ß√£o simples
        if (!userUrl) {
            showMessage("Por favor, insira um URL.", "error");
            return;
        }

        // 2. Iniciar o estado de carregamento
        setLoading(true);
        showMessage("Preparando seu download... üîó", "loading");
        resultArea.innerHTML = ""; // Limpa resultados anteriores

        // 3. L√≥gica de sele√ß√£o de plataforma (ATUALIZADA)
        try {
            // Valida√ß√µes de plataforma
            switch (platform) {
                case "instagram":
                    if (!userUrl.includes("instagram.com")) {
                        throw new Error("Este n√£o parece ser um link v√°lido do Instagram.");
                    }
                    break;
                
                case "tiktok":
                    if (!userUrl.includes("tiktok.com")) {
                        throw new Error("Este n√£o parece ser um link v√°lido do TikTok.");
                    }
                    break;
                
                case "youtube":
                    if (!userUrl.includes("youtube.com") && !userUrl.includes("youtu.be")) {
                         throw new Error("Este n√£o parece ser um link v√°lido do YouTube.");
                    }
                    break;
                
                default:
                    throw new Error("Plataforma desconhecida.");
            }

            // 4. (A SOLU√á√ÉO) Monta a URL do NOSSO backend (o proxy)
            // O frontend agora chama o '/api/proxy-download' que criamos no backend.
            const proxyUrl = `/api/proxy-download?platform=${platform}&url=${encodeURIComponent(userUrl)}`;

            // 5. Exibe o link de download
            displayDownloadLink(proxyUrl);
            
            // 6. Sucesso!
            setLoading(false);
            showMessage(""); 

        } catch (error) {
            // 7. Tratar erros
            console.error(error); 
            setLoading(false);
            showMessage(error.message || "Oops! Algo deu errado. Tente novamente.", "error");
            resultArea.innerHTML = "";
        }
    });

    /**
     * ATUALIZADO: Fun√ß√£o √∫nica para exibir o link de download
     * Esta fun√ß√£o n√£o baixa nada, apenas cria o link <a>
     * O 'download' sem nome de arquivo funciona porque o backend (proxy)
     * j√° est√° enviando o nome do arquivo (Content-Disposition).
     */
    function displayDownloadLink(proxyUrl) {
        resultArea.innerHTML = `
            <a href="${proxyUrl}" class="download-link" download>
                Download Conclu√≠do! Clique aqui ‚ù§Ô∏è
            </a>
        `;
    }

    // As fun√ß√µes async downloadInstagram, downloadTikTok e downloadYouTube
    // foram removidas pois n√£o s√£o mais necess√°rias. O backend cuida de tudo.


    // Fun√ß√£o para ligar/desligar o estado de carregamento do bot√£o
    function setLoading(isLoading) {
        if (isLoading) {
            downloadButton.disabled = true;
            buttonText.style.display = "none";
            buttonLoader.style.display = "block";
        } else {
            downloadButton.disabled = false;
            buttonText.style.display = "block";
            buttonLoader.style.display = "none";
        }
    }

    // Fun√ß√£o para mostrar mensagens ao usu√°rio
    function showMessage(message, type = "") {
        messageArea.textContent = message;
        if (type === "error") {
            messageArea.className = "error-message";
        } else if (type === "loading") {
            messageArea.className = "loading-message";
        } else {
            messageArea.className = "";
        }
    }
});
